#template{:style=>"display: none;"}
  .uk-placeholder{:id=>"channel{0}"}
    .uk-badge.uk-badge-success.uk-margin-bottom
      Канал №{0}
    .uk-form-row{:style=>"margin-bottom: 20px;"}
      %label{:for=>"channelname{0}"} Название:
      %input.channelname.uk-width-1-1{:type=>"text", :placeholder=>"Название", :name=>"channelname{0}", :id=>"channelname{0}"}
      %br
      %label.error.uk-text-small.uk-text-danger{:for=>"channelname{0}"}
    .uk-form-row{:style=>"margin-bottom: 20px;"}
      %label{:for=>"channeltype{0}"} Тип:
      %input.channeltype{:type=>"radio", :name=>"channeltype{0}", :value=>"email", :id=>"channeltype{0}"} Электронная почта
      %input.channeltype{:type=>"radio", :name=>"channeltype{0}", :value=>"sms", :id=>"channeltype{0}"} SMS
      %br
      %label.error.uk-text-small.uk-text-danger{:for=>"channeltype{0}"}
    .uk-form-row{:style=>"margin-bottom: 20px; display: none;", :id=>"channelemail{0}"}
      %input.channelemail.uk-width-1-1{:type=>"text", :placeholder=>"Адрес электронной почты", :name=>"channelemail{0}"}
      %br
      %label.error.uk-text-small.uk-text-danger{:for=>"channelemail{0}"}
    .uk-form-row{:style=>"margin-bottom: 20px; display: none;", :id=>"channelsms{0}"}
      %input.channelsms.uk-width-1-1{:type=>"text", :placeholder=>"Номер мобильного телефона", :name=>"channelsms{0}"}
      %br
      %label.error.uk-text-small.uk-text-danger{:for=>"channelsms{0}"}
    .uk-form-row{:style=>"margin-bottom: 20px;"}
      %label{:for=>"channelpattern{0}"} Шаблон:
      %textarea.channelpattern.uk-width-1-1{:type=>"text", :name=>"channelpattern{0}", :rows=>"6", :id=>"channelpattern{0}"}
      %br
      %label.error.uk-text-small.uk-text-danger{:for=>"channelpattern{0}"}
    .uk-text-center
      %a.checkpattern.uk-button{:href=>"#", :id=>"checkpattern{0}"}
        Тест        

.lane{:style=>"background-color: #FFF"}
  %h1 Настройка учетной записи
  %form#account.uk-form{:action => "/configure", :method=>"post"}
    #step3
      .uk-alert
        Шаг 3/4 - настройка каналов передачи показаний счетчиков
      %p
        %div
          На этом шаге давайте настроим каналы передачи показаний счетчиков и шаблоны отправляемых по ним сообщений.
          -brand
          подерживает передачу показаний по email и по SMS. Передача показаний по SMS возможна только после
          %a{:href=>"/upgrade"} покупки полного функционала.
      %p
        %div
          Для настройки каналов передачи вы должны знать:
          %ul
            %li адрес электронной почты получателя (если показания будут передаваться по электронной почте)
            %li мобильный номер получателя (если показания будут передаваться по SMS)
            %li формат, отправляемого по каналу сообщения (более актуально для передачи по SMS, т.к. как правило показания по электронной почте передаются в произвольной форме)
          Эту информацию вы можете уточнить на сайтах сбытовых и распределительных компаний.
      %p
        %div
          Для создания канала передачи определите его название, например,
          %code Показания для ДУК
          , выберите тип, укажите получателя (адрес электронной почты или мобильный номер) и сформируйте шаблон сообщения, отправляемого по этому каналу.
          Для формирования шаблона перенесите
          %code
            элементы данных
          , находящихся справа, в текстовое поле шаблона.
          Для проверки корректности формирования сообщения по вашему шаблону, воспользуйетсь функцией "ТЕСТ".
          А при помощи кнопок
          %code +
          и
          %code -
          вы можете настроить необходимое количество каналов передачи.
      %p
        %div          
          Если же сейчас вы не готовы настроить каналы передачи данных, то это можно сделать позже.         
      .uk-container-center.uk-width-xlarge-2-3
        .uk-grid
          .uk-width-2-3
            .uk-panel.uk-panel-box.uk-panel-box-secondary.uk-margin-bottom
              #channels
              .uk-text-center
                %button.uk-button#btnDel{:disabled=>"", :style=>"margin-right: 20px;", :type=>"button"}
                  %i.uk-icon-minus
                %button.uk-button#btnAdd{:type=>"button"}
                  %i.uk-icon-plus
          .uk-width-1-3
            .uk-panel.uk-panel-box.uk-panel-box-secondary.uk-margin-bottom{"data-uk-sticky" => "{top:50, bottom:590}", :style=>"z-index: 1;"}
              -patternpanel
      .uk-text-center
        %a.uk-button.uk-button-primary#tostep4{:href=>"#"}
          Далее
          %i.uk-icon-angle-double-right
    #step4{:style=>"display: none;"}
      .uk-alert
        Шаг 4/4 - создание напоминаний
      %p
        %div
          Мы в единственном шаге от завершения настройки учетной записи. Осталось установить дату, когда
          -brand
          будет напоминать вам о необходимости передачи показаний счетчиков.
          -brand
          подерживает отправку напоминаний по email и по SMS. Отправка напоминания по SMS возможна только после
          %a{:href=>"/upgrade"} покупки полного функционала
          -"."
          Если вы хотите получать такие напоминания, то выберите выберите соответствующую опцию и укажите способ отправки, реквизиты получателя напоминания и дату.
      .uk-container-center.uk-width-2-3
        .uk-panel.uk-panel-box.uk-panel-box-secondary.uk-margin-bottom
          .uk-form-row{:style=>"margin-bottom: 20px;"}
            %label{:for=>"notificationtype"} Получать напоминания:
            %input.notificationtype{:type=>"radio", :name=>"notificationtype", :value=>"none", :id=>"notificationtype"} нет
            %input.notificationtype{:type=>"radio", :name=>"notificationtype", :value=>"email", :id=>"notificationtype"} по электронной почте
            %input.notificationtype{:type=>"radio", :name=>"notificationtype", :value=>"sms", :id=>"notificationtype"} по SMS
            %br
            %label.error.uk-text-small.uk-text-danger{:for=>"notificationtype"}
          .uk-form-row{:style=>"margin-bottom: 20px; display: none;", :id=>"notificationemail"}
            %input.notificationemail.uk-width-1-1{:type=>"text", :placeholder=>"Адрес электронной почты", :name=>"notificationemail"}
            %br
            %label.error.uk-text-small.uk-text-danger{:for=>"notificationemail"}
          .uk-form-row{:style=>"margin-bottom: 20px; display: none;", :id=>"notificationsms"}
            %input.notificationsms.uk-width-1-1{:type=>"text", :placeholder=>"Номер мобильного телефона", :name=>"notificationsms"}
            %br
            %label.error.uk-text-small.uk-text-danger{:for=>"notificationsms"}
          .uk-form-row{:style=>"margin-bottom: 20px; display: none;", :id=>"notificationdate"}
            %label{:for=>"notificationdate"} Выберите дату получения уведомлений (число каждого месяца):
            %input.notificationdate{:name=>"notificationdate", :type=>"text", "data-uk-datepicker"=>"{weekstart: 1, format: 'DD', i18n: {months:['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь', 'Декабрь'], weekdays:['Вс','Пн','Вт','Ср','Чт','Пт','Сб']}}"}
            %br
            %label.error.uk-text-small.uk-text-danger{:for=>"notificationdate"}
          .uk-form-row{:style=>"margin-bottom: 20px; display: none;", :id=>"notificationtimezone"}
            %label{:for=>"notificationtimezone"} Выберите часовой пояс, в котром вы находитесь:
            %select.notificationtimezone{:name=>"notificationtimezone", :type=>"text"}
              %option{:disabled=>"", :selected=>""} Выберите часовой пояс
              %option{:value=>"+2"} Калининград... (МСК-1)
              %option{:value=>"+3"} Москва, С.Петербург, Н.Новгород, Волгоград... (МСК)
              %option{:value=>"+4"} Самара, Ижевск... (МСК+1)
              %option{:value=>"+5"} Екатеринбург, Пермь, Уфа, Челябинск, Тюмень... (МСК+2)
              %option{:value=>"+6"} Омск, Новосибирск, Барнаул, Кемерово, Томск... (МСК+3)
              %option{:value=>"+7"} Красноярск, Нориоьск, Абакан... (МСК+4)
              %option{:value=>"+8"} Чита, Иркутск, Улан-Удэ... (МСК+5)
              %option{:value=>"+9"} Якутск, Благовещенск... (МСК+6)
              %option{:value=>"+10"} Владивосток, Хабаровск, Магадан... (МСК+7)
              %option{:value=>"+11"} Среднеколымск, Северо-Курильск... (МСК+8)
              %option{:value=>"+12"} Петропавловск-Камчатский, Анадырь... (МСК+9)
            %br
            %label.error.uk-text-small.uk-text-danger{:for=>"notificationtimezone"}
          .uk-form-row{:style=>"margin-bottom: 20px; display: none;", :id=>"notificationtime"}
            %label{:for=>"notificationtime"} Выберите час отправки уведомлений:
            %select.notificationtime{:name=>"notificationtime", :type=>"text"}
              %option{:disabled=>"", :selected=>""} Выберите час
              %option{:value=>"0"} 00
              %option{:value=>"1"} 01
              %option{:value=>"2"} 02
              %option{:value=>"3"} 03
              %option{:value=>"4"} 04
              %option{:value=>"5"} 05
              %option{:value=>"6"} 06
              %option{:value=>"7"} 07
              %option{:value=>"8"} 08
              %option{:value=>"9"} 09
              %option{:value=>"10"} 10
              %option{:value=>"11"} 11
              %option{:value=>"12"} 12
              %option{:value=>"13"} 13
              %option{:value=>"14"} 14
              %option{:value=>"15"} 15
              %option{:value=>"16"} 16
              %option{:value=>"17"} 17
              %option{:value=>"18"} 18
              %option{:value=>"19"} 19
              %option{:value=>"20"} 20
              %option{:value=>"21"} 21
              %option{:value=>"22"} 22
              %option{:value=>"23"} 23
            %br
            %label.error.uk-text-small.uk-text-danger{:for=>"notificationtime"}
      .uk-text-center
        %a.uk-button#backtostep3{:href=>"#", :style=>"margin-right: 20px;"}
          %i.uk-icon-angle-double-left
          Назад
        %button.uk-button.uk-button-primary#finish{:type=>"submit"}
          Далее
          %i.uk-icon-angle-double-right
          
      //%button.uk-button.uk-button-large.uk-button-primary.uk-align-center{:type=>"submit"} Войти
    

#patterntestmodal.uk-modal
  .uk-modal-dialog.uk-modal-dialog-slide
    %a.uk-modal-close.uk-close
    %h2 Тест шаблона
    %p
      %div
        Ниже находится пример сообщения, сформированного по вашему шаблону. Разумеется, вместо
        %code ##
        будут ваши реальные показания счетчиков, которые вы введете перед отправкой сообщения.
    %pre
      %code
        #patterntestresult

:javascript
  
  $(function() {
  
    $("input[type=radio][name*='notificationtype']").change(function() {
        if (this.value == 'email') {
            $('#notificationemail').show();
            $('#notificationsms').hide();
            $('#notificationdate').show();
            $('#notificationtimezone').show();
            $('#notificationtime').show();

        }
        if (this.value == 'sms') {
            $('#notificationemail').hide();
            $('#notificationsms').show();
            $('#notificationdate').show();
            $('#notificationtimezone').show();
            $('#notificationtime').show();

        }
        if (this.value == 'none') {
            $('#notificationemail').hide();
            $('#notificationsms').hide();
            $('#notificationdate').hide();
            $('#notificationtimezone').hide();
            $('#notificationtime').hide();
        }
    });
    
    $(document.body).on("change", "input[type=radio][name*='channeltype']", function() {
        var k = ($(this).attr('name')).match(/\d+$/);
        if (this.value == 'email') {
            $('#channelemail'+k).show();
            $('#channelsms'+k).hide();
        }
        else if (this.value == 'sms') {
            $('#channelemail'+k).hide();
            $('#channelsms'+k).show();
        }
    });

    $("#btnAdd").click(addRow);
    $("#btnDel").click(delRow);

    var template = jQuery.validator.format($("#template").html());

    function addRow() {

      $("#channels").append(template(i));
      initDroppable($("#channelpattern"+i));
      i++;
      if (i>2) {
        $('#btnDel').prop('disabled', false)
      }
    }
    
    function delRow() {
      if(i>2) {
        i--;
        $("#channel" + i).remove();
        if (i==2) {
          $('#btnDel').prop('disabled', true)
        }
      }
    }

    var i = 1;

    addRow();
    
    $('#tostep4').click(function() {
      if ($('#account').valid()) {
        $('#step3').toggle();
        $('#step4').toggle();
      }
    });

    $('#backtostep3').click(function() {
      if ($('#account').valid()) {
        $('#step4').toggle();
        $('#step3').toggle();
      }
    });


    $.validator.addMethod("nameRequired", $.validator.methods.required, "Введите название");
    $.validator.addMethod("nameMaxlength", $.validator.methods.maxlength, $.format("Название должно быть менее {0} символов"));

    $.validator.addMethod("chaneltypeRequired", $.validator.methods.required, "Выберите канал передачи показаний счетчиков");
    
    $.validator.addMethod("emailRequired", $.validator.methods.required, "Введите адрес электронной почты получателя показаний счетчиков");
    $.validator.addMethod("emailEmail", $.validator.methods.email, "Введите корректный адрес электронной почты");

    $.validator.addMethod("smsRequired", $.validator.methods.required, "Введите мобильный номер получателя показаний счетчиков");
    
    $.validator.addMethod("patternRequired", $.validator.methods.required, "Введите шаблон");
    $.validator.addMethod("patternMaxlength", $.validator.methods.maxlength, $.format("Название должно быть менее {0} символов"));

    $.validator.addMethod("notificationtypeRequired", $.validator.methods.required, "Выберите канал передачи показаний счетчиков");

    $.validator.addMethod("notificationemailRequired", $.validator.methods.required, "Введите адрес электронной почты получателя уведомлений");
    $.validator.addMethod("notificationemailEmail", $.validator.methods.email, "Введите корректный адрес электронной почты");

    $.validator.addMethod("notificationsmsRequired", $.validator.methods.required, "Введите мобильный номер получателя уведомлений");

    $.validator.addMethod("notificationdateRequired", $.validator.methods.required, "Выберите день отправки уведомления");
    $.validator.addMethod("notificationdateDigits", $.validator.methods.digits, $.format("Поле может содержать только цифры"));
    $.validator.addMethod("notificationdateMax", $.validator.methods.max, $.format("Число должно быть не более {0}"));

    $.validator.addMethod("notificationtimezoneRequired", $.validator.methods.required, "Выберите временную зону");

    $.validator.addMethod("notificationtimeRequired", $.validator.methods.required, "Выберите время");

    $.validator.addClassRules({
      channelname: {
        nameRequired: true,
        nameMaxlength: 500
      },
      channeltype: {
        chaneltypeRequired: true
      },
      channelemail: {
        emailRequired: true,
        emailEmail: true
      },
      channelsms: {
        smsRequired: true,
        remote: {
          url: "/ajax/checkphone",
          type: "post"
        }
      },
      channelpattern: {
        patternRequired: true,
        patternMaxlength: 65535
      },
      notificationtype: {
        notificationtypeRequired: true
      },
      notificationemail: {
        notificationemailRequired: true,
        notificationemailEmail: true
      },
      notificationsms: {
        notificationsmsRequired: true,
        remote: {
          url: "/ajax/checkphone2",
          type: "post"
        }
      },
      notificationdate: {
        notificationdateRequired: true,
        notificationdateDigits: true,
        notificationdateMax: 31
      },
      notificationtimezone: {
        notificationtimezoneRequired: true
      },
      notificationtime: {
        notificationtimeRequired: true
      }
    });

    $(".draggable").draggable({
      appendTo: "body",
      opacity: 0.7,
      helper: "clone",
      cursor: "move",
      revert: "invalid"
    });

    //initDroppable($(".channelpattern"));
    function initDroppable($elements) {
      $elements.droppable({
        hoverClass: "textarea",
        accept: ":not(.ui-sortable-helper)",
        drop: function(event, ui) {
          var $this = $(this);
          var tempid = ui.draggable.text().trim();
          var dropText;
          dropText = "{"+tempid+"}";
          var droparea = document.getElementById($this.attr("id"));
          var range1 = droparea.selectionStart;
          var range2 = droparea.selectionEnd;
          var val = droparea.value;
          var str1 = val.substring(0, range1);
          var str3 = val.substring(range1, val.length);
          droparea.value = str1 + dropText + str3;
          SetCaretAtEnd(droparea);
        }
      });
    }
    
    function SetCaretAtEnd(elem) {
      var elemLen = elem.value.length;
      // For IE Only
      if (document.selection) {
          // Set focus
          elem.focus();
          // Use IE Ranges
          var oSel = document.selection.createRange();
          // Reset position to 0 & then set at end
          oSel.moveStart('character', -elemLen);
          oSel.moveStart('character', elemLen);
          oSel.moveEnd('character', 0);
          oSel.select();
      }
      else if (elem.selectionStart || elem.selectionStart == '0') {
          // Firefox/Chrome
          elem.selectionStart = elemLen;
          elem.selectionEnd = elemLen;
          elem.focus();
      } // if
    } // SetCaretAtEnd()

    $(document.body).on("click", ".checkpattern", function() {
      var k = ($(this).attr('id')).match(/\d+$/);
      var data = $('#channelpattern'+k).val();
      var modal = $.UIkit.modal("#patterntestmodal");
      $.ajax({
        type: "POST",
        dataType: "text",
        url: "/ajax/testpattern",
        data: "pattern=" + data,
        success: function(reply_text) {
          //alert(reply_text);
          $("#patterntestresult").html(reply_text);
          modal.show();
        }
      });
    });
  });